const { CDS_USE_NODEMON } = process.env
module.exports = CDS_USE_NODEMON ? require('nodemon') : ({ script, ext, env, options={} })=>{

  // Phoning home...
  const EventEmitter = require('events')
  const emitter = new EventEmitter
  process.on('exit', ()=> emitter.emit('quit'))

  // Re-starting child process...
  const { fork } = require('child_process')
  let child
  const restart = (evt, name)=>{
    const execArgv = []
    if (child) child.kill()
    if (evt && evt.startsWith('--')) execArgv.push(evt)
    if (name && name.startsWith('--')) execArgv.push(name)
    if (options.debug) execArgv.push('--inspect')
    if (options['debug-brk']) execArgv.push('--inspect-brk')
    const files = evt === "update" ? [ name ] : undefined
    emitter.emit ('restart', files)
    child = fork (script, { env, stdio:'inherit', execArgv }, (err)=>{
      if (err) console.error (err)
    })
  }
  restart()

  // Watching for touched files...
  const watch = require('node-watch')
  let include = RegExp(`\\.(${ext.replace(/,/g,'|')})$`)
  let exclude = /node_modules/
  let filter = f => !exclude.test(f) && include.test(f)
  watch (process.cwd(),{ recursive:true, filter }, restart)

  // Live commands...
  const readline = require('readline')
  readline.createInterface(process.stdin).on('line', (input) => {
    if (input === '') { console.log('restart'); restart() }
    else if (input === 'restart' || input === 'rs') restart()
    else if (input === 'debug' || input === 'dbg')  restart('--inspect')
    else if (input === 'break' || input === 'brk')  restart('--inspect-brk')
    else if (input === 'debug-brk')  restart('--inspect-brk')
    else if (input === 'ps') ps(child,env)
    else if (input === 'bye') { child.kill(); process.exit() }
    else console.log ('?\n')
  })

  return emitter
}

const ps = (child,env) => console.log (`\x1b[32m
  PID     Process   Command
  ${process.pid}   parent    cds ${process.argv.slice(2).join(' ')}
  ${  child.pid}   child     cds ${JSON.parse(env._args).join(' ')}
  \x1b[0m`
)
